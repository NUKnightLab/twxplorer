{% extends "base.html" %}

{% block extrahead %}
<script type="application/javascript" src="http://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script type="application/javascript" src="{{ STATIC_URL }}js/Loader.js" charset="utf-8"></script>
<script type="application/javascript" src="{{ STATIC_URL }}js/common.js" charset="utf-8"></script>
{% endblock %}

{% block content %}

<div id='control_bar' class="row-fluid">
    <div class="span9">
        <form class="form-inline">
            <select id="list">
{% for list in lists %}
                <option value='{{ list.id_str }}'>{{ list.full_name }}</option>
{% endfor %}
            </select>
            <select id="language">
{% for item in languages %}
                <option value='{{ item.1 }}'>{{ item.0|capitalize }}</option>
{% endfor %}
            </select>
            <button type="button" class="btn btn-default" id="search"><i class="icon-search"></i></button>
        </form>
    </div>
    <div id='username' class="span3">
    Logged in as @{{ session.username }}
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    {{ error }}
</div>
{% endif %}

<div class="row-fluid spaced">   
    <div id="tweet_count" class="span4">
    </div>
    <div class="span8 filter-container">
        <ul id="filter_list" class="filter-list">
        </ul>
    </div>
</div>

<div class="row-fluid">   
     <div id='tweets' class="span4">
        <p>Select a list and click the <i class="icon-search"></i> 
        button to retrieve tweets authored by members of the specified list.</p>
        
        <p>The system will attempt to retrieve up to 500 tweets.  The tweets will
        be displayed in this space.  Common terms, hashtags, and URLs will be displayed
        in the panels to the right. <i class="icon-arrow-right"></i></p>
        
        <p>You can click on any term, hashtag, or URL to filter the list of tweets
         to those containing the selected item.</p>
         
        <!-- tweets go here -->       
    </div>
   <div class="span8">
        <div class="row-fluid spaced">   
            <div class="span7 frame">
                <div class="frame-header">Terms</div>
                <div id='terms' class="frame-body">
                    <!-- terms go here --> 
                </div>
            </div>
            <div class="span5 frame">
                <div class="frame-header">Hashtags</div>
                <div id="hashtags" class="frame-body">
                    <!-- hashtags go here -->
                </div>   
            </div>
        </div>
        <div class="row-fluid">
            <div class="span12 frame">
                <div class="frame-header">URLs</div>
                <div id="urls" class="frame-body">
                    <!-- hashtags go here -->
                </div>   
            </div>
        </div>
    </div>    
</div>

<div id="progress_modal" class="modal fade">
<div class="modal-dialog">
<div class="modal-content">
    <div class="modal-body">
        <p><i class="icon-spinner icon-spin"></i> Searching twitter...</p>
    </div>
</div>
</div>
</div>


{% endblock %}

{% block script %}

<script type="text/javascript">

var _session_id = '{{ session_id }}';
var _stem_map = {};
var _url_map = {};

var _filter = [];   // current filter      

var _TermsLoader;
var _HashtagsLoader;
var _TweetsLoader;
var _UrlsLoader;


// Get the term to represent filter item in UI
function get_term(s, sep) {
    if(s[0] == '#') {
        return s;
    }   
    if(s in _url_map) {
        return _url_map[s];  
    }
    if(s in _stem_map) {    
        return _stem_map[s].join(sep || ',');
    }
    return s;
}

function add_filter(stem) {
    _filter.push(stem);
    filter_results(_session_id);
}

function remove_filter(stem) {
    var stem_index = $.inArray(stem, _filter);
    if(stem_index > -1) {
        _filter.splice(stem_index, 1);
    }
    filter_results(_session_id);
}

function show_filter() {   
    var s = '';
    
    for(var i = 0; i < _filter.length; i++) {
        s += '<li>'+get_term(_filter[i])
            + '<button class="close" onclick="remove_filter(\''+_filter[i]+'\');">&times;</button>'
            + '</li>';      
    }
    
    $('#filter_list').html(s).show();
}

//
// Get stats and tweets for session_id using _filter
//
function filter_results(session_id, callback) { 
    _session_id = session_id;

    show_filter(); 
    
    $('#terms, #hashtags, #urls, #tweets, #tweet_count').html('');
        
    do_ajax('/filter/'+_session_id+'/', 
        {filter: _filter},
        function(err) {
            show_error('Error filtering results ('+err+')');
            if(callback) {
                callback();
            }
        },
        function(data) {       
            _stem_map = data.stem_map;
            
            $('#list').val(data.list_id);
            $('#language').val(data.language);
            $('#tweet_count').html(data.tweets.length+' tweets');
                     
            _TermsLoader.set_data(data.stem_counts).load_more();
            _HashtagLoader.set_data(data.hashtag_counts).load_more();
            _TweetsLoader.set_data(data.tweets).load_more();            
            _UrlsLoader.set_data(data.url_counts).show_loading().load_more();
                                                                        
            if(callback) {
                callback();
            }
        }
    );
}

function load_session(session_id, callback) {
    _filter = [];
    filter_results(session_id, callback);  
}

//
// on load
//
$(function() {
    $('#progress_modal').modal({
        keyboard: false,
        show: false
    })
            
    $('#language').val('{{ session.language }}');

    $('#search').click(function(event) {
        clear_error();
        
        // TODO: CHECK FOR WHATEVER
        var list_id = $('#list').val();
        if(!list_id) {
            show_error('You must select a list');
            return;
        }
    
        $('#progress_modal').modal('show');
    
        do_ajax("{{ url_for('analyze') }}", 
            {language: $('#language').val(), list_id: list_id},
            function(error) {
                show_error('Error executing search ('+error+')');
                $('#progress_modal').modal('hide');
            },
            function(data) {   
                load_session(data.session._id, function() {
                    $('#progress_modal').modal('hide');
                });
            }
        );
    });
    
    //
    // Loaders
    //
    _TermsLoader = new Loader($('#terms'), 10,
        function(stem_counts, callback) {   
            var html = '';
            var max_count =  _TermsLoader.data[0][1];
            
            for(var i = 0; i < stem_counts.length; i++) {                   
                var stem = stem_counts[i][0];
                var count = stem_counts[i][1];
                var pct = (count * 100)/max_count;
            
                html += ''
                    + '<div class="term" onclick="add_filter(\''+stem+'\');">'
                    + '<span class="count">'+count+'</span>'
                    + '<div class="inner">'
                    + '<a>'+get_term(stem, ', ')+'</a>'
                    + '<div class="bar" style="width: '+pct+'%;">&nbsp;</div>'
                    + '</div>'
                    + '</div>';     
            }            
            callback(html);       
        }
    );
 
    _HashtagLoader = new Loader($('#hashtags'), 20,
        function(hashtag_counts, callback) {
            var hashtag, count, html = '';
            
            if(hashtag_counts.length) {
                for(var i = 0; i < hashtag_counts.length; i++) {                   
                    hashtag = hashtag_counts[i][0];
                    count = hashtag_counts[i][1];
            
                    html += ''
                        + '<p><a href="javascript:void(0);" onclick="add_filter(\''+hashtag+'\')">'
                        + hashtag+'</a> ('+count+')</p>';
                }  
            } else {
                html = '<p class="msg">no hashtags found</p>';
            }          
            callback(html);       
        }
    );
    
    _TweetsLoader = new Loader($('#tweets'), 10, 
        function(tweets, callback) {
            var html = '';

            for(var i = 0; i < tweets.length; i++) {      
                var tweet = tweets[i];
                             
                html += ''
                    + '<blockquote class="twitter-tweet" data-conversation="none" data-cards="hidden">'
                    + '<p>'+tweet.text+'</p>&mdash; '+tweet.user_name + ' (@'+tweet.user_screen_name+')'
                    + '<a href="https://twitter.com/twitterapi/status/'+tweet.id_str+'">'+tweet.created_at+'</a>'               
                    + '</blockquote>';
                //html += '<p>'+tweet.id_str+'</p>';
            }
            callback(html);
        },
        function() {
            twttr.widgets.load();
        }
    );
    
    _UrlsLoader = new Loader($('#urls'), 6,
        function(url_counts, callback) {   
            var urls = $.map(url_counts, function(elem, i) { return elem[0]; });
            
            if(urls.length) {                  
                do_ajax("{{ url_for('urls') }}", 
                    {urls: urls},
                    function(error) {
                        show_error(error);
                        callback('');
                    },
                    function(data) {   
                        var info, html = '';
                    
                        for(var i = 0; i < data.info.length; i++) {
                            info = data.info[i];
                            
                            _url_map[info.url] = (info.title || info.url);
                            
                            html += ''
                                + '<p>'
                                + '<span class="count">('+url_counts[i][1]+')</span>'
                                + '<a href="javascript:void(0);" onclick="add_filter(\''+info.url+'\');">'+ _url_map[info.url] +'</a>'
                                + '<a class="external-link" href="'+info.url+'" target="_blank" title="open url in new window">'
                                + '<i class="icon-external-link"></i></a>'
                                + '</p>';
                        }
                    
                        callback(html);
                    }
                );
            } else {
                callback('<p class="msg">no urls found</p>');
            }                   
        }
    );

    //
    // LOAD SESSION?
    //
    if(_session_id) {
        load_session(_session_id);
    }    
});

</script>
{% endblock %}