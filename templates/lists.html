{% extends "base.html" %}

{% block extrahead %}
<script type="application/javascript" src="http://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script type="application/javascript" src="{{ STATIC_URL }}js/Loader.js" charset="utf-8"></script>
<script type="application/javascript" src="{{ STATIC_URL }}js/date.js" charset="utf-8"></script>
<script type="application/javascript" src="{{ STATIC_URL }}js/common.js" charset="utf-8"></script>
{% endblock %}

{% block content %}
<div id='control_bar' class="row-fluid">
    <div class="container">
    <div class="span9">
        <form class="form-inline">
            <select id="list">
                <option value=''>Choose list</option>
{% for list in lists %}
                <option value='{{ list.id_str }}'>{{ list.full_name }}</option>
{% endfor %}
            </select>
            <select id="language">
{% for item in languages %}
                <option value='{{ item.1 }}'>{{ item.0|capitalize }}</option>
{% endfor %}
            </select>
            <button type="button" class="btn btn-default" id="search">view</button>
            <div class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">saved snapshots</a>
                <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                    <li class="head"><a href="/history/">view all saved snapshots</a></li>
                    {% for r in saved_results %}
                    <li>
                        {{ r.list_name }}
                        <ul class="unstyled"> 
                            {% for sess in r.sessions %}
                            <li><a href="/lists/{{ sess._id }}/">{{ sess.dt }}</a></li>
                        {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </form>
    </div>
    <div id='username' class="span3">
        Logged in as @{{ session.username }} <a href="{{ url_for('logout') }}">logout</a>
    </div>
</div>
</div>
  <div id="content" class="container">

{% if error %}
<div class="alert alert-danger">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    {{ error }}
</div>
{% endif %}

<div class="row-fluid spaced">   
    <div class="span12">
        <ul class="inline breadcrumbs">
{% if not lists %}
            <li><span id='list_label'>You currently don't follow any twitter lists. <a href="https://support.twitter.com/articles/76460-using-twitter-lists" target="_blank">Learn more</a> about lists.</li>
{% else %}
            <li><span id='list_label'>Choose one of your lists above to begin.</span> <span id="timestamp"></span></li>
{% endif %}
            <li>
                <div class="filter-container">
                    <ul id="filter_list" class="filter-list"></ul>
                </div>
                <a onclick="clear_filters();" class="internal"><span id="current_term"></span></a>
            </li>
            <li><span id="tweet_count"></span></li>
            <li><button type="button" class="btn btn-link" id="save" style="display: none;">Save snapshot</button></li>
        </ul>
    </div>
</div>

<div id="main-content" class="row-fluid cover">
    <div class="span4">
        <div class="frame-header tweet-header">Recent Tweets</div>
        <div id='tweets'>
           <!-- tweets go here -->
        </div>
    </div>
   <div class="span8">
        <div class="row-fluid spaced">   
            <div class="span7 frame">
                <div class="frame-header">Terms</div>
                <div class="frame-body">
                    <ul id='terms' class="unstyled">
                        <!-- terms go here -->
                    </ul>
                </div>
            </div>
            <div class="span5 frame">
                <div class="frame-header">Hashtags</div>
                <div class="frame-body">
                   <ul id="hashtags" class="unstyled">
                     <!-- hashtags go here -->
                   </ul>
                </div>   
            </div>
        </div>
        <div class="row-fluid">
            <div class="span12 frame">
                <div class="frame-header">Links</div>
                <div class="frame-body">
                    <ul id="urls" class="unstyled">
                        <!-- hashtags go here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>    
</div>
{% endblock %}

{% block script %}
<script type="text/javascript">

var _session = {};
var _url_map = {};
var _list_map = {{ list_map|safe }};

var _filter = [];   // current filter      

var _TermsLoader;
var _HashtagsLoader;
var _TweetsLoader;
var _UrlsLoader;


// Get the term to represent filter item in UI
function get_term(s) {
    if(s[0] == '#') {
        return s;
    }   
    if(s in _url_map) {
        return _url_map[s];  
    }
    if(s in _session.stem_map) { 
        if(_session.stem_map[s].length > 1) {
            return _session.stem_map[s][0]+', ...';
        } 
        return _session.stem_map[s];
    }
    return s;
}

function add_filter(stem) {
    _filter.push(stem);
    filter_results(_session._id);
}

function remove_filter(stem) {
    var stem_index = $.inArray(stem, _filter);
    if(stem_index > -1) {
        _filter.splice(stem_index, 1);
    }
    filter_results(_session._id);
}

function clear_filters() {
    if(_filter.length > 0){
        _filter = []
        filter_results(_session._id);
    }
}

function show_filter() {   
    var s = '';
    
    if(_filter.length > 0) {
       s = '<li class="blank">&nbsp; Filters: </li>';
    }
    for(var i = 0; i < _filter.length; i++) {
        s += '<li>'+get_term(_filter[i])
            + '<button class="close" onclick="remove_filter(\''+_filter[i]+'\');">&times;</button>'
            + '</li>';      
    }
    
    $('#filter_list').html(s).show();
}

//
// Get stats and tweets for session_id using _filter
//

function filter_results(session_id, callback) { 
    show_filter(); 
    
    $('#terms, #hashtags, #urls, #tweets, #tweet_count, #timestamp').html('');
        
    do_ajax('/filter/'+session_id+'/', 
        {filter: _filter},
        function(err) {
            show_error('Error filtering results ('+err+')');
            if(callback) {
                callback();
            }
        },
        function(data) {       
            _session = data.session;    
            
            $('#list').val('');
            $('#main-content').removeClass('cover');
            if(_session.saved) {
                $('#list_label').html('Saved snapshot from list:');
            } else {
                $('#list_label').html('List');
            }
            $('#current_term').html(_list_map[data.search.list_id] || data.search.list_name || '[unknown]');
            $('#timestamp').html('on '
                + Date.parse(_session.dt.split('.')[0]).toString("M/d/yy HH:mm")+':');
           
            $('#language').val(data.search.language);
            $('#tweet_count').html('('+data.tweets.length+' tweets, '+data.retweets+' retweets)');
                     
            _TermsLoader.set_data(data.stem_counts).load_more();
            _HashtagLoader.set_data(data.hashtag_counts).load_more();
            _TweetsLoader.set_data(data.tweets).load_more();            
            _UrlsLoader.set_data(data.url_counts).show_loading().load_more();
                                                                        
            if(callback) {
                callback();
            }
        }
    );
}

//
// on load
//
$(function() {           
    if($('#language option[value={{ session.language }}]').length) {
        $('#language').val('{{ session.language }}');
    } else {
        $('#language').val('en');
    }
       
    $('#search').click(function(event) {
        hide_error();
        
        var list_id = $('#list').val();
        if(!list_id) {
            show_error('You must select a list');
            return;
        }
    
        show_progress('Searching Twitter');
    
        do_ajax("{{ url_for('analyze') }}", 
            {language: $('#language').val(), list_id: list_id},
            function(error) {
                show_error('Error executing search ('+error+')');
                hide_progress();
            },
            function(data) {   
                _filter = [];
                filter_results(data.session._id, function() {
                    hide_progress();
                });
                
                $('#save').show();
            }
        );
    });
 
    $('#save').click(function(event) {
        hide_error();
        
        show_progress('Saving results');
        
        do_ajax('/history/save/'+_session._id+'/', 
            {},
            function(error) {
                show_error('Error saving results ('+error+')');
                hide_progress();
             },
            function(data) {  
                _session.saved = 1; 
                hide_progress();
                $('#save').hide();
            }
        );
    });
       
    initialize_loaders();
    //
    // LOAD SESSION?
    //
{% if session_id %}
    filter_results('{{ session_id }}');
{% endif %}

});

</script>
{% endblock %}