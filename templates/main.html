{% extends "base.html" %}

{% block extrahead %}
<script type="application/javascript" src="http://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script type="application/javascript" src="{{ STATIC_URL }}js/Loader.js" charset="utf-8"></script>
{% endblock %}

{% block content %}

<div id='control_bar' class="row-fluid">
    <div class="span8">
        <form class="form-inline">
            <input type="text" class="form-control" id="query" value="" size="100" placeholder="Enter your search query" />
            <div class="btn-group">
                <button type="button" class="btn btn-default" id="search"><i class="icon-search"></i></button>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    <span class="caret">&nbsp;&nbsp;&nbsp;</span>
                </button>
                <ul class="dropdown-menu">
                    <li><a id="past_searches" href="javascript:void(0);" onclick="show_history();">View past searches</a></li>
                    <li><a id="exclude_words" href="javascript:void(0);" onclick="not_implemented();">Exclude words</a></li>
                </ul>
            </div>    
        </form>
    </div>
    <div id='username' class="span4">
    Logged in as @{{ session.username }}
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    {{ error }}
</div>
{% endif %}

<div class="row-fluid spaced">   
    <div class="span9 filter-container">
        <ul id="filter_list" class="filter-list">
        </ul>
    </div>
    <div id="tweet_count" class="span3">
    </div>
</div>

<div class="row-fluid">   
    <div id='column1' class="span8">
        <div class="row-fluid spaced">   
            <div id='terms' class="span7 frame">
            <!-- terms go here --> 
   
            </div>
            <div id='hashtags' class="span5 frame">
            <!-- hashtags go here -->     
            </div>
        </div>
        <div class="row-fluid">
            <div id="urls" class="span12 frame">
            </div>
        </div>
    </div>    
    <div id='tweets' class="span4">
        <!-- tweets go here -->       
    </div>
</div>

<div id="progress_modal" class="modal fade">
<div class="modal-dialog">
<div class="modal-content">
    <div class="modal-body">
        <p><i class="icon-spinner icon-spin"></i> Searching twitter...</p>
    </div>
</div>
</div>
</div>

<div id="history_modal" class="modal fade">
<div class="modal-dialog">
<div class="modal-content">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Search History</h4>
    </div>
    <div class="modal-body">
        <div class="accordion" id="history_accordion">
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" id='history_delete' class="btn btn-default" onclick="delete_selected_history();">Delete Selected</button>
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    </div>
</div>
</div>
</div>

{% endblock %}

{% block script %}

<script type="text/javascript">

var _session_id = '';
var _stem_map = {};
var _filter = '';       // current filter, comma-delimited string

var _url_map = {};

var _TermsLoader;
var _HashtagsLoader;
var _TweetsLoader;
var _UrlsLoader;


function not_implemented() {
    alert('Not implemented yet!');
}

function clear_error() {
    $('#error_alert').remove();
}

function show_error(error) {  
    if($('#error_alert').length) {
        $('#error_alert .error-msg').html(error);
    } else {        
        $('#control_bar').after(
            '<div id="error_alert" class="alert alert-danger">'
            + '<button type="button" class="close" data-dismiss="alert">&times;</button>'
            + '<span class="error-msg">'+error + '</span></div>'
        );
    }
}

function do_ajax(url, data, on_error, on_success) {
    $.ajax({
        url: url,
        data: data,
        dataType: 'json',
        timeout: 45000, // ms
        error: function(xhr, status, err) {
            on_error(err || status);
        },
        success: function(data) {
            if(data.error) {
                on_error(data.error);
            } else {
                on_success(data);
            }
        }
    });
}

// Get the term to represent filter item in UI
function get_term(s, sep) {
    if(s[0] == '#') {
        return s;
    }   
    if(s in _url_map) {
        return _url_map[s];  
    }
    if(s in _stem_map) {    
        return $.map(_stem_map[s], function(elem, i) { return elem[0]; }).join(sep || ',');
    }
    return s;
}

function set_filter(filter) {
    _filter = filter;
    filter_results(_session_id);    
}

function add_filter(stem) {
    _filter += (_filter) ? ','+stem : stem;
    filter_results(_session_id);
}

function remove_filter(stem) {
    var stems = _filter.split(',');
    var stem_index = $.inArray(stem, stems);
    if(stem_index > -1) {
        stems.splice(stem_index, 1);
    }
    set_filter(stems.join(','));
}

function show_filter() {   
    var s = '';
    
    if(_filter) {
        stems = _filter.split(',');
        for(var i = 0; i < stems.length; i++) {
            s += '<li>'+get_term(stems[i])
                + '<button class="close" onclick="remove_filter(\''+stems[i]+'\');">&times;</button>'
                + '</li>';      
        }
    }    
    $('#filter_list').html(s).show();
}

//
// Get stats and tweets for session_id using _filter
//
function filter_results(session_id, callback) { 
    _session_id = session_id;

    show_filter(); 
    
    $('#terms, #hashtags, #urls, #tweets, #tweet_count').html('');
        
    do_ajax('/search/'+_session_id+'/', 
        {filter: _filter},
        function(err) {
            show_error('Error filtering results ('+err+')');
            if(callback) {
                callback();
            }
        },
        function(data) {       
            _stem_map = data.stem_map;
            
            $('#query').val(data.query);
            $('#tweet_count').html(data.tweets.length+' tweets');
                     
            _TermsLoader.set_data(data.stem_counts).load_more();
            _HashtagLoader.set_data(data.hashtag_counts).load_more();
            _TweetsLoader.set_data(data.tweets).load_more();            
            _UrlsLoader.set_data(data.url_counts).show_loading().load_more();
                                                                        
            if(callback) {
                callback();
            }
        }
    );
}

function load_session(session_id, callback) {
    _filter = '';
    filter_results(session_id, callback);  
}


//
// History
//

function delete_selected_history() {
    if(confirm("Delete selected search sessions?")) {
        var searches = [];
        var sessions = [];
        
        $('#history_modal').modal('hide');
    
        $('#history_accordion input.search:checked').each(function() {
            searches.push($(this).val());
        });
        
        $('#history_accordion input.session:checked').each(function() {
            sessions.push($(this).val());
        });
        
        do_ajax("{{ url_for('history_delete') }}",
            {searches: searches, sessions: sessions},
            function(err) {
                show_error('Error deleting searches ('+err+')');
            },
            function(data) {
                if($.inArray(_session_id, data.deleted) > -1) {
                    document.location.href = "{{ url_for('main') }}";
                }
            }
        );            
    }
}

function show_history() {
    do_ajax("{{ url_for('history') }}", 
        {},
        function(err) {
            show_error('Error getting search history ('+err+')');
        },
        function(data) {
            var s = '';
            
            for(var i = 0, searches = data.searches; i < searches.length; i++) {
                var search = searches[i];
                var collapse_id = 'collapse_'+search._id;
                
                s += '<div class="accordion-group">'
                    // ---
                    + '<div class="accordion-heading">'
                    + '<input type="checkbox" class="search" value="'+search._id+'" />'
                    + '<a class="accordion-toggle" data-toggle="collapse" data-parent="#history_accordion" href="#'+collapse_id+'">'
                    + search.query + '</a>'
                    + '</div>'
                    // ---
                    + '<div id="'+collapse_id+'" class="accordion-body collapse">'
                    + '<div class="accordion-inner">';
                              
                for(var j = 0, sessions = search.sessions; j < sessions.length; j++) {
                    s += '<p>'
                        + '<input type="checkbox" class="session" value="'+sessions[j]._id+'" />'
                        + '<a href="javascript:void(0);" data-dismiss="modal" onclick="load_session(\''+sessions[j]._id+'\');">'
                        + sessions[j].dt+'</a>'
                        + '</p>';
                }          
                
                s += '</div></div></div>';           
            }
            
            if(data.searches.length) {
                $('#history_delete').show();
            } else {
                $('#history_delete').hide();
            } 
            $('#history_accordion').html(s ? s : '<p>No past searches found</p>');            
            $('#history_modal').modal('show');
        }
    );
}

//
// on load
//
$(function() {
    $('#progress_modal').modal({
        keyboard: false,
        show: false
    })
    
    $('#history_modal').modal({
        keyboard: false,
        show: false
    })

    $('#query')
        .keypress(function(event) {
            if(event.which == 13) {
                event.preventDefault();
                $('#search').click();
            }
        })
        .focus();

    $('#search').click(function(event) {
        clear_error();
        
        var query = $('#query').val().trim();
        if(!query) {
            show_error('You must enter a query');
            return;
        } 
    
        $('#progress_modal').modal('show');
    
        do_ajax("{{ url_for('search') }}", 
            {query: query},
            function(error) {
                show_error('Error executing search ('+error+')');
                $('#progress_modal').modal('hide');
            },
            function(data) {   
                load_session(data.session._id, function() {
                    $('#progress_modal').modal('hide');
                });
            }
        );
    });
    
    //
    // Loaders
    //
    _TermsLoader = new Loader($('#terms'), 10,
        function(stem_counts, callback) {   
            var html = '';
            var max_count =  _TermsLoader.data[0][1];
            
            for(var i = 0; i < stem_counts.length; i++) {                   
                var stem = stem_counts[i][0];
                var count = stem_counts[i][1];
                var pct = (count * 100)/max_count;
            
                html += ''
                    + '<div class="term" onclick="add_filter(\''+stem+'\');">'
                    + '<span class="count">'+count+'</span>'
                    + '<div class="inner">'
                    + '<label>'+get_term(stem, ', ')+'</label>'
                    + '<div class="bar" style="width: '+pct+'%;">&nbsp;</div>'
                    + '</div>'
                    + '</div>';     
            }            
            callback(html);       
        }
    );
 
    _HashtagLoader = new Loader($('#hashtags'), 20,
        function(hashtag_counts, callback) {
            var hashtag, count, html = '';
            
            if(hashtag_counts.length) {
                for(var i = 0; i < hashtag_counts.length; i++) {                   
                    hashtag = hashtag_counts[i][0];
                    count = hashtag_counts[i][1];
            
                    html += ''
                        + '<p><a href="javascript:void(0);" onclick="add_filter(\''+hashtag+'\')">'
                        + hashtag+'</a> ('+count+')</p>';
                }  
            } else {
                html = '<p class="msg">no hashtags found</p>';
            }          
            callback(html);       
        }
    );
    
    _TweetsLoader = new Loader($('#tweets'), 10, 
        function(tweets, callback) {
            var html = '';

            for(var i = 0; i < tweets.length; i++) {      
                var tweet = tweets[i];
                             
                html += ''
                    + '<blockquote class="twitter-tweet" data-conversation="none" data-cards="hidden">'
                    + '<p>'+tweet.text+'</p>&mdash; '+tweet.user_name + ' (@'+tweet.user_screen_name+')'
                    + '<a href="https://twitter.com/twitterapi/status/'+tweet.id_str+'">'+tweet.created_at+'</a>'               
                    + '</blockquote>';
            }
            callback(html);
        },
        function() {
            twttr.widgets.load();
        }
    );
    
    _UrlsLoader = new Loader($('#urls'), 6,
        function(url_counts, callback) {   
            var urls = $.map(url_counts, function(elem, i) { return elem[0]; });
            
            if(urls.length) {                  
                do_ajax("{{ url_for('urls') }}", 
                    {urls: urls},
                    function(error) {
                        show_error(error);
                        callback('');
                    },
                    function(data) {   
                        var info, html = '';
                    
                        for(var i = 0; i < data.info.length; i++) {
                            info = data.info[i];
                            
                            _url_map[info.url] = (info.title || info.url);
                            
                            html += ''
                                + '<p>'
                                + '<span class="count">('+url_counts[i][1]+')</span>'
                                + '<a href="javascript:void(0);" onclick="add_filter(\''+info.url+'\');">'+ _url_map[info.url] +'</a>'
                                + '<a class="external-link" href="'+info.url+'" target="_blank" title="open url in new window">'
                                + '<i class="icon-external-link"></i></a>'
                                + '</p>';
                        }
                    
                        callback(html);
                    }
                );
            } else {
                callback('<p class="msg">no urls found</p>');
            }                   
        }
    );
    
});

</script>

{% endblock %}