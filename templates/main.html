{% extends "base.html" %}

{% block content %}

<div id='control_bar' class="row-fluid">
    <div class="span12">
        <form class="form-inline">
            <input type="text" class="form-control" id="query" value="" size="100" placeholder="Enter your search query" />
            <div class="btn-group">
                <button type="button" class="btn btn-default" id="search"><i class="icon-search"></i></button>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><a id="past_searches" href="javascript:void(0);" onclick="not_implemented();">View past searches</a></li>
                    <li><a id="exclude_words" href="javascript:void(0);" onclick="not_implemented();">Exclude words</a></li>
                </ul>
            </div>    
        </form>
    </div>
</div>

{% if error %}
<div class="alert alert-danger">
    <button type="button" class="close" data-dismiss="alert">&times;</button>
    {{ error }}
</div>
{% endif %}

<div class="row-fluid">
    <div class="span12">
        <ul id='breadcrumb' class="breadcrumb" style="display: none;">
        </ul>
    </div>
</div>

<div class="row-fluid" style="position: relative;">
    <div id='histogram' class="span6">
        <!-- histogram goes here -->
    </div>
    <div id='tweets' class="span6">
        <!-- tweets go here -->
    </div>
</div>

<div id="progress_modal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <p><i class="icon-spinner icon-spin"></i> Searching twitter&hellip;</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}

<script type="text/javascript">

var _search_id = '';
var _session_id = '';
var _stem_map = {};
var _filter = '';       // current filter, for drill down


function not_implemented() {
    alert('Not implemented yet!');
}

function show_error(error) {
    var s = '<div class="alert alert-danger">'
        + '<button type="button" class="close" data-dismiss="alert">&times;</button>'
        + error + '</div>';
        
    $('#control_bar').after(s);
}

function do_ajax(url, data, on_error, on_success) {
    $.ajax({
        url: url,
        data: data,
        dataType: 'json',
        timeout: 30000, // ms
        error: function(xhr, status, err) {
            on_error(err);
        },
        success: function(data) {
            if(data.error) {
                on_error(data.error);
            } else {
                on_success(data);
            }
        }
    });
}

function set_filter(filter) {
    _filter = filter;
    filter_results();    
}

function add_filter(stem) {
    _filter += (_filter) ? ','+stem : stem;
    filter_results();
}

function set_breadcrumb() {          
    if(_filter) { 
        var s = '<li><a href="javascript:void(0);" onclick="set_filter(\'\');">All</a></li>';
               
        stems = _filter.split(',');
        var last = stems.pop();
        for(var i = 0; i < stems.length; i++) {
            var filter = stems.slice(0, i+1).join(','); 
            var terms = _stem_map[stems[i]][0][0];
            s += '<li><a href="javascript:void(0);" onclick="set_filter(\''+filter+'\');">'
                +terms
                +'</a></li>';
        }        
        s += '<li class="active">'+_stem_map[last][0][0]+'</li>';    
        $('#breadcrumb').html(s).show();        
    } else {
        var s = '<li class="active">All</li>';
        $('#breadcrumb').html(s).show();
    }     
}

//
// Show histogram, hiding any elements of _filter
//
function show_histogram(stem_counts) {
    var s = '';
    var filter_stems = [];
    
    if(_filter) { 
        filter_stems = _filter.split(',');
    }
    
    for(var i = 0; i < stem_counts.length; i++) {
        stem = stem_counts[i][0];
        count = stem_counts[i][1];
        
        if($.inArray(stem, filter_stems) < 0) {
            terms = [];
            for(var j=0, m=_stem_map[stem]; j < m.length; j++) {
                terms.push(m[j][0]);
            }

            s += '<p><a href="javascript:void(0);" onclick="add_filter(\''+stem+'\')">'
                + terms.join(', ')+'</a> ('+count+')</p>';
        }
    }

    $('#histogram').html(s);     
}

//
// Show tweets
//
function show_tweets(tweets) {
    var s = '';
    
    for(var i = 0; i < tweets.length; i++) {
        var tweet = tweets[i];
        
        s += '<blockquote class="twitter-tweet" data-conversation="none" data-cards="hidden">'
            + '<p>'+tweet.text+'</p>&mdash; '+tweet.user_name + ' (@'+tweet.user_screen_name+')'
            + '<a href="https://twitter.com/twitterapi/status/'+tweet.id_str+'">'+tweet.created_at+'</a>'               
            + '</blockquote>';           
    }
    s += '<script type="application/javascript" src="http://platform.twitter.com/widgets.js" charset="utf-8">';
    s += '</script'+'>';
                
    $('#tweets').html(s);
}

//
// Get histogram and tweets for _filter
//
function filter_results(callback) {   
    set_breadcrumb(); 
      
    $('#tweets').html('');
        
    do_ajax('/main/search/'+_session_id+'/', 
        {filter: _filter},
        function(err) {
            show_error('Error filtering results ('+err+')');
            if(callback) {
                callback();
            }
        },
        function(data) {                
            show_histogram(data.stem_counts);
            show_tweets(data.tweets);                          
            if(callback) {
                callback();
            }
        }
    );
}

$(function() {

    $('#progress_modal').modal({
        keyboard: false,
        show: false
    })

    $('#query')
        .keypress(function(event) {
            if(event.which == 13) {
                event.preventDefault();
                $('#search').click();
            }
        })
        .focus();

    $('#search').click(function(event) {
        var query = $('#query').val().trim();
        if(!query) {
            show_error('You must enter a query');
            return;
        } 
    
        $('#progress_modal').modal('show');
    
        do_ajax('/main/search/', 
            {query: query},
            function(error) {
                show_error(error);
                $('#progress_modal').modal('hide');
            },
            function(data) {
                _search_id = data.search._id;
                _session_id = data.session._id;
                _stem_map = data.session.stem_map;
                _filter = '';    
                             
                filter_results(function() {
                    $('#progress_modal').modal('hide');
                });
            }
        );
    });
});

</script>

{% endblock %}